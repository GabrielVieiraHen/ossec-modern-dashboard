<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSSEC Logs Explorer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --dark-bg: #0f0f23;
            --dark-card: #1a1b2e;
            --dark-border: #2d2d4d;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--dark-bg); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Navbar */
        .navbar { background: var(--dark-card); border-bottom: 1px solid var(--dark-border); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .nav-brand { display: flex; align-items: center; gap: 15px; font-weight: 700; font-size: 1.2rem; }
        .nav-icon { width: 35px; height: 35px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .btn-back { background: transparent; border: 1px solid var(--dark-border); color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; text-decoration: none; transition: all 0.3s; font-size: 0.9rem; }
        .btn-back:hover { border-color: var(--primary); color: var(--primary); background: rgba(99, 102, 241, 0.1); }

        /* Main Layout */
        .explorer-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar (File Tree) */
        .sidebar { width: 300px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--dark-border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--dark-border); font-size: 0.9rem; color: var(--text-secondary); font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .file-list { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-radius: 6px; color: var(--text-secondary); font-size: 0.9rem; transition: all 0.2s; margin-bottom: 2px; }
        .file-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .file-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); }
        .file-icon { width: 20px; text-align: center; opacity: 0.7; }
        .fa-folder { color: #fbbf24; }
        .fa-file-alt { color: var(--text-secondary); }

        /* Content Area */
        .content-area { flex: 1; display: flex; flex-direction: column; background: #0d0e1b; }
        .content-header { padding: 15px 25px; border-bottom: 1px solid var(--dark-border); display: flex; justify-content: space-between; align-items: center; background: var(--dark-card); }
        .current-file { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--primary); }
        .content-body { flex: 1; overflow: auto; padding: 20px; position: relative; }
        
        /* Log Viewer */
        pre { margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.6; color: #e2e8f0; white-space: pre-wrap; word-break: break-all; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--dark-bg); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); opacity: 0.5; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; }
        
        .loading-overlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 15, 35, 0.8); align-items: center; justify-content: center; z-index: 10; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-brand">
            <div class="nav-icon"><i class="fas fa-history"></i></div>
            Arquivo de Logs
        </div>
        <a href="/dashboard" class="btn-back">
            <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>

    <div class="explorer-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-folder-tree"></i>
                <span id="current-folder-display">/</span>
                <button id="btn-up" class="btn-back" style="padding: 2px 8px; margin-left: auto; font-size: 0.8rem;" onclick="navigateUp()" title="Subir nível">
                    <i class="fas fa-level-up-alt"></i>
                </button>
            </div>
            <div class="file-list" id="file-list">
                </div>
        </div>

        <div class="content-area">
            <div class="content-header">
                <div class="current-file" id="file-name-display">Selecione um arquivo...</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Apenas leitura</div>
            </div>
            <div class="content-body">
                <div id="loading" class="loading-overlay">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary)"></i>
                    <span>Carregando arquivo...</span>
                </div>
                <div id="log-viewer">
                    <div class="empty-state">
                        <i class="far fa-file-alt"></i>
                        <p>Selecione um arquivo log à esquerda para visualizar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPath = '';

        document.addEventListener('DOMContentLoaded', () => {
            loadDirectory('');
        });

        async function loadDirectory(path) {
            try {
                const response = await fetch(`/api/logs/list?path=${path}`);
                const data = await response.json();

                if (data.status === 'success') {
                    currentPath = data.current_path;
                    document.getElementById('current-folder-display').textContent = currentPath ? `/${currentPath}` : '/';
                    renderFileList(data.items);
                    
                    // Esconde botão de subir se estiver na raiz
                    document.getElementById('btn-up').style.visibility = currentPath ? 'visible' : 'hidden';
                }
            } catch (error) {
                console.error('Erro ao listar arquivos:', error);
            }
        }

        function renderFileList(items) {
            const container = document.getElementById('file-list');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b; font-size: 0.9rem;">Pasta vazia</div>';
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'file-item';
                
                const iconClass = item.type === 'directory' ? 'fa-folder' : 'fa-file-alt';
                
                div.innerHTML = `
                    <div class="file-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="file-name">${item.name}</div>
                `;

                div.onclick = () => {
                    if (item.type === 'directory') {
                        loadDirectory(item.path);
                    } else {
                        loadFileContent(item.path, item.name);
                        // Highlight active
                        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                    }
                };

                container.appendChild(div);
            });
        }

        async function loadFileContent(path, name) {
            const viewer = document.getElementById('log-viewer');
            const loader = document.getElementById('loading');
            const title = document.getElementById('file-name-display');
            
            title.textContent = name;
            loader.classList.add('active');

            try {
                const response = await fetch(`/api/logs/content?path=${path}`);
                const data = await response.json();

                if (data.status === 'success') {
                    // Escapar HTML para segurança e preservar formatação
                    viewer.innerHTML = `<pre>${escapeHtml(data.content)}</pre>`;
                } else {
                    viewer.innerHTML = `<div style="color: var(--danger); padding: 20px;">Erro ao carregar arquivo: ${data.message}</div>`;
                }
            } catch (error) {
                viewer.innerHTML = `<div style="color: var(--danger); padding: 20px;">Erro de conexão.</div>`;
            } finally {
                loader.classList.remove('active');
            }
        }

        function navigateUp() {
            if (!currentPath) return;
            // Remove a última parte do caminho
            const parts = currentPath.split('/');
            parts.pop();
            loadDirectory(parts.join('/'));
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>